{%- import 'common/slurm_parallelcluster_utils.conf' as slurm_utils with context -%}

# This file is automatically generated by pcluster
{% set ns = namespace(has_node=false) +%}

{#- Slurm Configuration: #}

{% for compute_resource in queue_config.ComputeResources %}
    {% set static_size = compute_resource.MinCount %}
    {% set dynamic_size = compute_resource.MaxCount - compute_resource.MinCount %}
    {{- slurm_utils.node_definition(queue_name, compute_resource, static_size, dynamic_size) }}
    {%- if static_size > 0 or dynamic_size > 0 -%}
        {%- set ns.has_node = true -%}
    {%- endif %}
{% endfor %}

{% if ns.has_node %}
NodeSet={{ queue_name }}_nodes Nodes=
    {%- for compute_resource in queue_config.ComputeResources %}
        {% set static_size = compute_resource.MinCount %}
        {% set dynamic_size = compute_resource.MaxCount - compute_resource.MinCount %}
        {%- if static_size > 0 and dynamic_size > 0 -%}
            {{- slurm_utils.node_name(queue_name, compute_resource.Name, static_size, True) }},
            {{- slurm_utils.node_name(queue_name, compute_resource.Name, dynamic_size, False) }}
        {%- elif static_size > 0 -%}
            {{- slurm_utils.node_name(queue_name, compute_resource.Name, static_size, True) }}
        {%- elif dynamic_size > 0 -%}
            {{- slurm_utils.node_name(queue_name, compute_resource.Name, dynamic_size, False) }}
        {%- endif %}
    {{- "," if not loop.last else "" -}}
    {% endfor %}

PartitionName={{ queue_name }} Nodes={{ queue_name }}_nodes MaxTime=INFINITE State=UP{% if is_default_queue %} Default=YES{% endif %}

{% endif %}
